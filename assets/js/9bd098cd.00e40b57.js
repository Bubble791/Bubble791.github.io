"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3200],{9525:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>t,contentTitle:()=>r,default:()=>o,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var i=a(4848),l=a(8453);const s={sidebar_position:1,title:"\ud83d\udce6Main \u6e38\u620f\u7684\u8fd0\u884c",tags:["GBA \u56fe\u5f62","GBA \u6559\u7a0b"]},r=void 0,c={id:"gba/ui/API/Main",title:"\ud83d\udce6Main \u6e38\u620f\u7684\u8fd0\u884c",description:"\u7ffb\u8bd1\u548c\u8865\u5145: \u6ce1\u6ce1",source:"@site/docs/gba/ui/API/Main.md",sourceDirName:"gba/ui/API",slug:"/gba/ui/API/Main",permalink:"/docs/gba/ui/API/Main",draft:!1,unlisted:!1,tags:[{inline:!0,label:"GBA \u56fe\u5f62",permalink:"/docs/tags/gba-\u56fe\u5f62"},{inline:!0,label:"GBA \u6559\u7a0b",permalink:"/docs/tags/gba-\u6559\u7a0b"}],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"\ud83d\udce6Main \u6e38\u620f\u7684\u8fd0\u884c",tags:["GBA \u56fe\u5f62","GBA \u6559\u7a0b"]},sidebar:"gbaTutor",previous:{title:"\u51fd\u6570\u4ecb\u7ecd",permalink:"/docs/category/\u51fd\u6570\u4ecb\u7ecd"},next:{title:"\ud83d\udce6Task \u4efb\u52a1",permalink:"/docs/gba/ui/API/Task"}},t={},d=[{value:"\u6e38\u620f\u5faa\u73af",id:"\u6e38\u620f\u5faa\u73af",level:2},{value:"RunCallbacks()",id:"runcallbacks",level:3},{value:"\u4e3b\u56de\u8c03",id:"MainCallback",level:4},{value:"Sprite \u56de\u8c03",id:"SpriteCallback",level:4},{value:"Task \u4efb\u52a1",id:"Task",level:4},{value:"WaitForVBlank()",id:"waitforvblank",level:3},{value:"\u76f8\u5173\u51fd\u6570",id:"\u76f8\u5173\u51fd\u6570",level:2},{value:"SetMainCallback2",id:"SetMainCallback2",level:3},{value:"SetVBlankCallback",id:"SetVBlankCallback",level:3}];function h(n){const e={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["\u7ffb\u8bd1\u548c\u8865\u5145: ",(0,i.jsx)(e.a,{href:"https://github.com/Bubble791",children:"\u6ce1\u6ce1"})," ",(0,i.jsx)("br",{}),"\n\u539f\u4f5c\u8005: ",(0,i.jsx)(e.a,{href:"https://github.com/pret/pokeemerald/wiki/Overview%E2%88%B6-The-Game-Loop",children:"Pokeemerald Wiki by huderlem"})," ",(0,i.jsx)("br",{})]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u6e38\u620f\u5faa\u73af",children:"\u6e38\u620f\u5faa\u73af"}),"\n",(0,i.jsx)(e.p,{children:"\u8bb8\u591a\u6e38\u620f\u90fd\u6709\u6240\u8c13\u7684\u201c\u6e38\u620f\u5faa\u73af\u201d\uff0c\u8fd9\u662f\u66f4\u65b0\u6e38\u620f\u72b6\u6001\u7684\u4e3b\u8981\u63a7\u5236\u6d41\u7a0b\u3002\u4ece\u9ad8\u5c42\u6b21\u6765\u770b\uff0c\u5b83\u770b\u8d77\u6765\u50cf\u8fd9\u6837\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"while (1)\n{\n    ReadPlayerInput(); // \u83b7\u53d6\u73a9\u5bb6\u7684\u8f93\u5165\uff0c\u6bd4\u5982\u6309\u952e\n    UpdateGameState(); // \u66f4\u65b0\u6e38\u620f\u72b6\u6001\n    DrawScreen(); // \u7ed8\u5236\u6e38\u620f\u753b\u9762\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"GBA\u7cfb\u5217\u7684\u4e09\u4ee3\u6e38\u620f\u4e5f\u4e0d\u4f8b\u5916\uff0c\u4f46\u5b83\u4eec\u7684\u6e38\u620f\u5faa\u73af\u770b\u8d77\u6765\u5e76\u4e0d\u50cf\u4e0a\u9762\u7684\u4f8b\u5b50\u90a3\u4e48\u6e05\u6670\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u8ba9\u6211\u4eec\u770b\u770b\u6e38\u620f\u5faa\u73af\u4ee3\u7801\uff0c\u4f4d\u4e8esrc/main.c\u7684gbMain()\u51fd\u6570\u5185\u90e8\uff0c\u8be5\u51fd\u6570\u662f\u6e38\u620f\u4ee3\u7801\u7684\u5165\u53e3\u70b9\u3002\u5982\u679c\u4f60\u6d4f\u89c8\u4e00\u4e0b\u6e38\u620f\u521d\u59cb\u5316\u4ee3\u7801\uff0c\u4f60\u4f1a\u770b\u5230\u4e00\u4e2a\u65e0\u9650for\u5faa\u73af\uff0c\u5373\u6e38\u620f\u5faa\u73af\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"// src/main.c\nfor (;;)\n{\n    ReadKeys();\n\n    if (gSoftResetDisabled == FALSE\n     && JOY_HELD_RAW(A_BUTTON)\n     && JOY_HELD_RAW(B_START_SELECT) == B_START_SELECT)\n    {\n        rfu_REQ_stopMode();\n        rfu_waitREQComplete();\n        DoSoftReset();\n    }\n\n    if (Overworld_SendKeysToLinkIsRunning() == TRUE)\n    {\n        gLinkTransferringData = TRUE;\n        UpdateLinkAndCallCallbacks();\n        gLinkTransferringData = FALSE;\n    }\n    else\n    {\n        gLinkTransferringData = FALSE;\n        UpdateLinkAndCallCallbacks();\n\n        if (Overworld_RecvKeysFromLinkIsRunning() == TRUE)\n        {\n            gMain.newKeys = 0;\n            ClearSpriteCopyRequests();\n            gLinkTransferringData = TRUE;\n            UpdateLinkAndCallCallbacks();\n            gLinkTransferringData = FALSE;\n        }\n    }\n\n    PlayTimeCounter_Update();\n    MapMusicMain();\n    WaitForVBlank();\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5ffd\u7565\u4e0e\u8054\u673a\u76f8\u5173\u7684\u529f\u80fd\uff0c\u5b83\u5f52\u7ed3\u4e3a\u8fd9\u4e2a\u9ad8\u7ea7\u6d41\u7a0b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"while (1)\n{\n\tReadPlayerInput();\n\tCheckForSoftReset();\n\tRunCallbacks();\n\tUpdatePlayTimeCounter();\n\tUpdateMusic();\n\tWaitForVBlank();\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u524d\u9762\u63cf\u8ff0\u7684\u5e38\u89c1\u6e38\u620f\u5faa\u73af\u4e0e3\u4ee3\u7cfb\u5217\u6e38\u620f\u5faa\u73af\u6709\u4e24\u4e2a\u4e3b\u8981\u533a\u522b\u3002"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"RunCallbacks()"}),"\u800c\u4e0d\u662f",(0,i.jsx)(e.code,{children:"UpdateGameState()"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"WaitForVBlank()"}),"\u800c\u4e0d\u662f",(0,i.jsx)(e.code,{children:"DrawScreen()"})]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"runcallbacks",children:"RunCallbacks()"}),"\n",(0,i.jsxs)(e.p,{children:["3\u4ee3\u7684\u4ee3\u7801\u5927\u91cf\u4f7f\u7528\u4e86\u201c\u56de\u8c03\u201d\uff0c\u5373\u5728\u672a\u6765\u67d0\u4e2a\u65f6\u95f4\u8c03\u7528\u7684\u51fd\u6570\uff0c\u5e76\u4e14\u53ef\u80fd\u4ee5\u91cd\u590d\u95f4\u9694\u8c03\u7528\uff0c\u5728\u6e38\u620f\u5faa\u73af\u4e2d\u8fd0\u884c\u7684\u56de\u8c03\u901a\u5e38\u6709",(0,i.jsx)(e.a,{href:"#MainCallback",children:"\u4e3b\u56de\u8c03"}),"\u3001",(0,i.jsx)(e.a,{href:"#SpriteCallback",children:"Sprite\u56fe\u50cf\u56de\u8c03"}),"\u548c",(0,i.jsx)(e.a,{href:"#Task",children:"Task \u4efb\u52a1"}),"\u3002"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.a,{href:"#MainCallback",children:"\u4e3b\u56de\u8c03"}),"\u51b3\u5b9a\u4e86",(0,i.jsx)(e.a,{href:"#SpriteCallback",children:"Sprite\u56fe\u50cf\u56de\u8c03"}),"\u548c",(0,i.jsx)(e.a,{href:"#Task",children:"Task \u4efb\u52a1"}),"\u662f\u5426\u8fd0\u884c\uff0c",(0,i.jsx)(e.a,{href:"#SpriteCallback",children:"Sprite\u56fe\u50cf\u56de\u8c03"}),"\u548c",(0,i.jsx)(e.a,{href:"#Task",children:"Task \u4efb\u52a1"}),"\u7684\u6267\u884c\u987a\u5e8f\u53d6\u51b3\u4e8e\u4ed6\u4eec\u5bf9\u5e94\u7684\u8fd0\u884c\u51fd\u6570\u5728",(0,i.jsx)(e.a,{href:"#MainCallback",children:"\u4e3b\u56de\u8c03"}),"\u51fd\u6570\u4e2d\u7684\u987a\u5e8f"]}),"\n",(0,i.jsx)(e.h4,{id:"MainCallback",children:"\u4e3b\u56de\u8c03"}),"\n",(0,i.jsx)(e.p,{children:"\u6700\u4e3b\u8981\u7684\u56de\u8c03\uff0c\u4e00\u5171\u6709\u4e24\u4e2a\uff0c\u6e38\u620f\u5faa\u73af\u6bcf\u5e27\u90fd\u4f1a\u8c03\u7528\u5b83\u4eec\u4e00\u6b21\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"// src/main.c\nstatic void CallCallbacks(void)\n{\n    if (gMain.callback1)\n        gMain.callback1();\n\n    if (gMain.callback2)\n        gMain.callback2();\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u7531\u4e8e\u4e3b\u56de\u8c03\u51fd\u6570\u6bcf\u4e00\u5e27\u90fd\u4f1a\u88ab\u8c03\u7528\uff0c\u56e0\u6b64\u6e38\u620f\u7684\u5927\u90e8\u5206\u903b\u8f91\u90fd\u5b58\u5728\u4e8e\u4e3b\u56de\u8c03\u51fd\u6570\u4e2d\u3002\u8bb8\u591a\u4e3b\u56de\u8c03\u51fd\u6570\u7684\u7ed3\u6784\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u7ed3\u6784\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"void MyBasicMainCallback(void)\n{\n    // \u8fd0\u884c\u6240\u6709\u6fc0\u6d3b\u7684Task\u56de\u8c03\n    RunTasks();\n\n    // \u8fd0\u884c\u5f53\u524d\u6240\u6709\u7684Sprite\u56de\u8c03\n    AnimateSprites();\n\n    // \u5c06\u6240\u6709Sprite\u6570\u636e\u5728V-Blank\u671f\u95f4\u590d\u5236\u5230VRAM\u7684\u7f13\u51b2\u533a\u3002\n    BuildOamBuffer();\n\n    // \u5b58\u5728\u6de1\u51fa\u6de1\u5165\u6548\u679c\u65f6\uff0c\u8fd0\u884c\u8272\u677f\u7684\u6de1\u51fa\u6de1\u5165\u6548\u679c\n    // \u901a\u5e38\u7528\u4e8e\u573a\u666f\u4e4b\u95f4\u7684\u5207\u6362\n    UpdatePaletteFade();\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u4e3a\u4e86\u4f7f\u4e0a\u8ff0\u56de\u8c03\u6bcf\u5e27\u6267\u884c\u4e00\u6b21\uff0c\u5fc5\u987b\u5c06\u5176\u5206\u914d\u7ed9\u4e24\u4e2a\u4e3b\u56de\u8c03\u4e4b\u4e00\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"gMain.callback1 = MyBasicCallback;\n// \u6216\u8005\nSetMainCallback2(MyBasicCallback);\n// \u6216\u8005\ngMain.callback2 = MyBasicCallback;\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u57fa\u672c\u5c06\u5176\u8bbe\u7f6e\u7ed9gMain.callback2\u7528\u4e8e\u4e3b\u8981\u6e38\u620f\u903b\u8f91\uff0cgMain.callback1\u5219\u4fdd\u7559\u7528\u4e8e\u66f4\u591a\u8f85\u52a9\u76f8\u5173\u903b\u8f91\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"SpriteCallback",children:"Sprite \u56de\u8c03"}),"\n",(0,i.jsx)(e.p,{children:"Sprite \u56de\u8c03\u662f\u9644\u52a0\u5230\u6240\u6709\u5355\u4e2astruct Sprite\u5bf9\u8c61\u7684\u51fd\u6570\u3002"}),"\n",(0,i.jsx)(e.p,{children:"Sprite \u56de\u8c03\u4e3b\u8981\u7528\u4e8e\u4e3a\u5176\u6240\u9644\u52a0\u7684OBJ\u56fe\u50cf\u5236\u4f5c\u52a8\u753b\uff0c\u5f53AnimateSprites()\u5728\u4e3b\u56de\u8c03\u4e2d\u8c03\u7528\u65f6\uff0c\u5219\u6bcf\u5e27\u53ea\u8c03\u7528\u4e00\u6b21Sprite \u56de\u8c03\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5982\u60a8\u6240\u89c1\uff0cAnimateSprites()\u904d\u5386\u6240\u6709\u6d3b\u52a8\u7cbe\u7075\u5e76\u8c03\u7528\u5b83\u4eec\u7684\u6bcf\u4e2a\u56de\u8c03\u51fd\u6570\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"// src/sprite.c\nvoid AnimateSprites(void)\n{\n    u8 i;\n    for (i = 0; i < MAX_SPRITES; i++)\n    {\n        struct Sprite *sprite = &gSprites[i];\n\n        if (sprite->inUse)\n        {\n            sprite->callback(sprite);\n\n            if (sprite->inUse)\n                AnimateSprite(sprite);\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"Sprite \u56de\u8c03\u65e0\u4efb\u4f55\u8fd4\u56de\u503c\uff0c\u5e76\u4e14struct Sprite *\u4f5c\u4e3a\u5176\u552f\u4e00\u53c2\u6570\uff0cSprite \u56de\u8c03\u901a\u5e38\u4f1a\u5bf9OBJ\u6267\u884c\u4e00\u4e9b\u52a8\u753b\u6216\u79fb\u52a8\uff0c\u7136\u540e\u5728OBJ\u7684\u751f\u547d\u5468\u671f\u7ed3\u675f\u65f6\u6e05\u9664OBJ\u3002"}),"\n",(0,i.jsx)(e.p,{children:"Sprite\u7ed3\u6784\u4f53\u4e2d\u6709\u4e00\u4e2a8\u5143\u7d20\u7684\u6570\u7ec4\u79f0\u4e3adata\uff0c\u4f9bSprite \u56de\u8c03\u7528\u4e8e\u4e00\u4e9b\u53c2\u6570\u8bfb\u53d6/\u4fdd\u5b58\u3002\u6b64data\u6570\u7ec4\u5728sprite\u521b\u5efa\u65f6\u521d\u59cb\u53160\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u662f\u4e00\u4e2a\u7b80\u5355\u793a\u4f8b\uff0c\u5b83\u5c06OBJ\u79fb\u52a8\u5230\u5c4f\u5e55\u4e0a\uff0c\u7136\u540e\u6e05\u9664\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"MoveRight_SpriteCallback(struct Sprite *sprite)\n{\n    // \u4f7f\u7528data[0]\u4f5c\u4e3a\u5e27\u6570.\n    // \u5f53\u5e27\u6570\u5927\u4e8e10, \u6e05\u9664\u5f53\u524d\u7684Sprite.\n    if (++sprite->data[0] > 10)\n        DestroySprite(sprite);\n    else\n        sprite->pos1.x++; // \u5c06\u5f53\u524d\u7684Sprite\u5411\u53f3\u79fb\u52a81\u50cf\u7d20\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u6709\u5173Sprite\u7684\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u9605\u540e\u7eed\u6587\u6863"}),"\n",(0,i.jsx)(e.h4,{id:"Task",children:(0,i.jsx)(e.a,{href:"Task",children:"Task \u4efb\u52a1"})}),"\n",(0,i.jsx)(e.p,{children:"Task\uff0c\u53c8\u53eb\u4efb\u52a1\uff0c\u662f3\u4ee3\u6e38\u620f\u4e2d\u4f7f\u7528\u7684\u7b2c\u4e09\u4e2a\u4e3b\u8981\u56de\u8c03\u3002\u5b83\u4eec\u7c7b\u4f3c\u4e8eSprite\u56de\u8c03\uff0c\u4f46\u672c\u8d28\u4e0a\u4e0d\u4f9d\u8d56\u4e8eSprite\u3002\u5047\u8bbeRunTasks()\u5728\u5176\u4e2d\u4e00\u4e2a\u4e3b\u56de\u8c03\u4e2d\u8c03\u7528\uff0c\u90a3\u4e48\u6bcf\u4e2a\u6fc0\u6d3b\u7684\u4efb\u52a1\u5c06\u6bcf\u5e27\u6267\u884c\u4e00\u6b21\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"// src/task.c\nvoid RunTasks(void)\n{\n    u8 taskId = FindFirstActiveTask();\n\n    if (taskId != NUM_TASKS)\n    {\n        do\n        {\n            gTasks[taskId].func(taskId);\n            taskId = gTasks[taskId].next;\n        } while (taskId != TAIL_SENTINEL);\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u6bcf\u4e2a\u4efb\u52a1\u90fd\u5206\u914d\u6709\u4f18\u5148\u7ea7\uff0c\u8fd9\u51b3\u5b9a\u4e86\u4efb\u52a1\u7684\u6267\u884c\u987a\u5e8f,\u6bcf\u5f53\u4f7f\u7528CreateTask()\u521b\u5efa\u65b0\u4efb\u52a1\u65f6\uff0c\u5b83\u90fd\u4f1a\u88ab\u63d2\u5165\u5230\u6d3b\u52a8\u4efb\u52a1\u7684\u5185\u5b58\u5217\u8868\u4e2d\uff0c\u6309\u4f18\u5148\u7ea7\u4ece\u4f4e\u5230\u9ad8\u6392\u5e8f\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0e Sprites \u7c7b\u4f3c\uff0cTask\u7ed3\u6784\u4e2d\u4e5f\u6709\u4e00\u4e2a\u901a\u7528data\u6570\u7ec4\uff0c\u4f46\u8fd9\u4e2a\u6570\u7ec4\u670916\u4e2a\u5143\u7d20\u3002Task\u662f\u8de8\u8d8a\u591a\u4e2a\u6e38\u620f\u5e27\u7684\u903b\u8f91\u7684\u57fa\u672c\u6784\u5efa\u5757\uff0c\u5b83\u4eec\u53ef\u4ee5\u975e\u5e38\u7075\u6d3b\u5730\u5b8c\u6210\u6307\u5b9a\u4efb\u52a1\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e3e\u4e00\u4e2a\u5c0f\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\uff0c\u6bcf\u6b21\u73a9\u5bb6\u6309\u4e0bA\u6309\u94ae\u65f6\u90fd\u4f1a\u64ad\u653e\u58f0\u97f3\uff0c\u6700\u591a10\u6b21\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"// 5 is the priority, and is not important.\nu8 taskId = CreateTask(ButtonPressSound_Task, 5);\n...\nvoid ButtonPressSound_Task(u8 taskId)\n{\n    if (gMain.newKeys & A_BUTTON)\n    {\n        PlaySE(SE_PC_LOGIN);\n        if (++gTasks[taskId].data[0] == 10)\n            DestroyTask(taskId);\n    }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u6709\u5173\u4efb\u52a1\u7684\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u9605",(0,i.jsx)(e.a,{href:"Task",children:"\u540e\u7eed\u6587\u6863"}),"\u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"waitforvblank",children:"WaitForVBlank()"}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u7528\u6e38\u620f\u5faa\u73af\u548c3\u4ee3\u6e38\u620f\u5faa\u73af\u4e4b\u95f4\u7684\u7b2c\u4e8c\u4e2a\u4e3b\u8981\u533a\u522b\u662fWaitForVBlank()\u800c\u4e0d\u662fDrawScreen()\u4e4b\u7c7b\u7684\u4e1c\u897f\u7ed8\u5236\u5c4f\u5e55\u56fe\u50cf\u3002\u8fd9\u662f\u56e0\u4e3aGame Boy Advance\u56fe\u5f62\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u4e0e\u73b0\u4ee3\u6e38\u620f\u5f00\u53d1\u4e2d\u76f4\u63a5\u5c06\u50cf\u7d20\u7ed8\u5236\u5230\u5c4f\u5e55\u6216\u50cf\u7d20\u7f13\u51b2\u533a\u4e0d\u540c\uff0cGame Boy Advance \u6709\u4e00\u4e2a\u4e13\u7528\u7684\u5185\u5b58\u533a\u57df\uff0c\u79f0\u4e3a VRAM\uff08\u89c6\u9891 RAM\uff09\uff0c\u5176\u4e2d\u5b58\u50a8\u7740\u56fe\u5757\u3001\u56fe\u5757Map\u3001\u8c03\u8272\u677f\u548cOBJ\u6570\u636e\u3002"}),"\n",(0,i.jsx)(e.p,{children:"VRAM\u7684\u8be6\u7ec6\u4fe1\u606f\u8d85\u51fa\u4e86\u672c\u6587\u6863\u7684\u8303\u56f4\u3002\u4f46\u662f\uff0c\u6e38\u620f\u5faa\u73af\u7684\u91cd\u70b9\u662f\uff0c\u6bcf\u79d2\u4f1a\u53d1\u751f60\u6b21\u6240\u8c13\u7684\u201cVBlank \u4e2d\u65ad\u201d\u3002\u8fd9\u662f\u89c6\u9891\u63a7\u5236\u5668\u5b8c\u6210\u5c06\u6700\u540e\u4e00\u884c\u50cf\u7d20\u7ed8\u5236\u5230\u5c4f\u5e55\u4e0a\u7684\u65f6\u95f4\uff0c\u56e0\u6b64GBA \u7684\u5c4f\u5e55\u5237\u65b0\u7387\u4e3a 60 fps\u3002\u901a\u8fc7\u5728WaitForVBlank()\u6bcf\u4e2a\u6e38\u620f\u5faa\u73af\u7ed3\u675f\u65f6\u8c03\u7528\uff0c\u786e\u4fdd\u6e38\u620f\u72b6\u6001\u8fdb\u5c55\u7684\u4e0a\u9650\u4e3a\u4e00\u81f4\u768460 fps\u3002"}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u76f8\u5173\u51fd\u6570",children:"\u76f8\u5173\u51fd\u6570"}),"\n",(0,i.jsxs)(e.p,{children:["\u4ee3\u7801\u6587\u4ef6\uff1a",(0,i.jsx)(e.a,{href:"https://github.com/pret/pokeemerald/blob/master/src/main.c",children:"src/main.c"})]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"SetMainCallback2",children:"SetMainCallback2"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"void SetMainCallback2(MainCallback callback);\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\ud83d\udcac\u5c06\u4e3b\u56de\u8c03",(0,i.jsx)(e.code,{children:"gMain.callback2"}),"\u8bbe\u7f6e\u4e3a\u6307\u5b9a\u7684\u51fd\u6570\uff0c\u6e38\u620f\u4e2d\u6700\u5e38\u7528\u7684\u4e3b\u56de\u8c03\u8bbe\u7f6e\u51fd\u6570\uff0c\u5728\u8c03\u7528\u65f6\u4f1a\u5c06",(0,i.jsx)(e.code,{children:"gMain.state"}),"\u521d\u59cb\u5316\u4e3a",(0,i.jsx)(e.code,{children:"0"})]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u53c2\u6570"}),(0,i.jsx)(e.th,{children:"\u7c7b\u578b"}),(0,i.jsx)(e.th,{children:"\u4ecb\u7ecd"})]})}),(0,i.jsx)(e.tbody,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"callback"}),(0,i.jsx)(e.td,{children:"MainCallback"}),(0,i.jsx)(e.td,{children:"\u56de\u8c03\u51fd\u6570\u7684\u5730\u5740"})]})})]}),"\n",(0,i.jsxs)(e.p,{children:["\u5728\u5207\u6362\u573a\u666f\u65f6\uff0c\u901a\u5e38\u4f1a\u5c06\u521d\u59cb\u5316\u5f53\u524d\u573a\u666f\u7684\u51fd\u6570\u7528",(0,i.jsx)(e.code,{children:"SetMainCallback2"}),"\u8bbe\u7f6e\u7ed9",(0,i.jsx)(e.code,{children:"MainCallback2"}),"\uff0c\u8fd9\u6837\u80fd\u907f\u514d\u4e0a\u4e00\u4e2a\u573a\u666f\u5b58\u7559\u5728Callback2\u4e2d\u7684\u56de\u8c03\u548c\u5176\u4ed6\u4efb\u52a1\uff08\u901a\u5e38\u4e3aTask\u3001Sprite\u56de\u8c03\uff0c\u6de1\u51fa\u6de1\u5165\u6548\u679c\uff0coam\u6784\u5efa\uff09\u4ecd\u5728\u8fd0\u884c\u5bfc\u81f4\u7684\u51fa\u9519"]}),"\n",(0,i.jsxs)(e.p,{children:["\u800c\u521d\u59cb\u5316\u5f53\u524d\u573a\u666f\u7684\u51fd\u6570\u4e2d\uff0c\u53ef\u4ee5\u6839\u636e",(0,i.jsx)(e.code,{children:"gMain.state"}),"\u7684\u503c\u4e00\u6b65\u6b65\u7684\u6e05\u7406\u6389\u4e4b\u524d\u7684\u6570\u636e\u5e76\u8bbe\u7f6e\u6210\u5f53\u524d\u573a\u666f\u6240\u9700\u8981\u7684\u914d\u7f6e"]}),"\n",(0,i.jsx)(e.p,{children:"\u2714\ufe0f\u5b9e\u4f8b\uff1a"}),"\n",(0,i.jsxs)(e.p,{children:["\u5728\u73a9\u5bb6\u6253\u5f00\u83dc\u5355\u9009\u62e9\u8bad\u7ec3\u5e08\u5361\u7247\u65f6\uff0c\u6e38\u620f\u4f1a\u5148\u7b49\u5f85\u6de1\u51fa\u6548\u679c\u6267\u884c\u5b8c\u6bd5\uff0c\u7136\u540e\u4f7f\u7528",(0,i.jsx)(e.code,{children:"SetMainCallback2"}),"\u5c06",(0,i.jsx)(e.code,{children:"MainCallback2"}),"\u8bbe\u7f6e\u4e3a",(0,i.jsx)(e.code,{children:"CB2_InitTrainerCard"}),"\uff0c\u6b64\u65f6\u91ce\u5916\u573a\u666f\u7684\u6240\u6709sprite\uff0ctask\u90fd\u88ab\u4e2d\u6b62\u8fd0\u884c\uff0c\u5c4f\u5e55\u5904\u4e8e\u4e00\u7247\u6f06\u9ed1"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"void ShowPlayerTrainerCard(void (*callback)(void))\n{\n    // \u521d\u59cb\u5316\u4e00\u7247\u5185\u5b58\u7528\u4e8e\u8bad\u7ec3\u5e08\u5361\u7247\u663e\u793a\n    sData = AllocZeroed(sizeof(*sData));\n    sData->callback2 = callback;\n    if (callback == CB2_ReshowFrontierPass)\n        sData->blendColor = RGB_WHITE;\n    else\n        sData->blendColor = RGB_BLACK;\n\n    if (InUnionRoom() == TRUE)\n        sData->isLink = TRUE;\n    else\n        sData->isLink = FALSE;\n\n    sData->language = GAME_LANGUAGE;\n    TrainerCard_GenerateCardForPlayer(&sData->trainerCard);\n    SetMainCallback2(CB2_InitTrainerCard); // \u5c06MainCallback2\u8bbe\u7f6e\u4e3aTrainerCard\u7684\u521d\u59cb\u5316\u51fd\u6570\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u63a5\u4e0b\u6765\u6e38\u620f\u4e13\u6ce8\u4e8e\u6267\u884c",(0,i.jsx)(e.code,{children:"CB2_InitTrainerCard"}),"\uff0c\u7531\u4e8e\u901a\u5e38\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u628a\u6240\u6709\u7684\u521d\u59cb\u5316\u4ee3\u7801\u5806\u4e00\u5757\u53bb\u6267\u884c\uff0c\u6240\u4ee5\u4f1a\u6839\u636e",(0,i.jsx)(e.code,{children:"gMain.state"}),"\u7684\u503c\u9010\u6b65\u521d\u59cb\u5316Vblank\u3001\u6e05\u7406\u4e4b\u524d\u91ce\u5916\u573a\u666f\u7684\u56fe\u50cfVARM\u6570\u636e\u3001\u6e05\u9664\u6240\u6709\u7684Sprite\u548cTask\u907f\u514d\u51b2\u7a81\u51fa\u73b0\u95ee\u9898\u3001\u6784\u5efa\u8bad\u7ec3\u5e08\u5361\u7247\u754c\u9762\u7684bg\u3001\u7b49\u7b49\u4e00\u7cfb\u5217\u52a8\u4f5c"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"static void CB2_InitTrainerCard(void)\n{\n    switch (gMain.state)\n    {\n    case 0:\n        ResetGpuRegs();\n        SetUpTrainerCardTask();\n        gMain.state++;\n        break;\n    case 1:\n        DmaClear32(3, (void *)OAM, OAM_SIZE);\n        gMain.state++;\n        break;\n    case 2:\n        if (!sData->blendColor)\n            DmaClear16(3, (void *)PLTT, PLTT_SIZE);\n        gMain.state++;\n        break;\n    case 3:\n        ResetSpriteData();\n        FreeAllSpritePalettes();\n        ResetPaletteFade();\n        gMain.state++;\n    // ...\n    default:\n        SetMainCallback2(CB2_TrainerCard);\n        break;\n    }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u5f53\u8fd0\u884c\u5230\u521d\u59cb\u5316\u7684\u6700\u540e\u4e00\u6b65\uff0c\u5c06",(0,i.jsx)(e.code,{children:"MainCallback2"}),"\u91cd\u65b0\u8bbe\u7f6e\u6210\u5305\u542b4\u79cd\u57fa\u7840\u8fd0\u884c\u51fd\u6570\u7684",(0,i.jsx)(e.code,{children:"CB2_TrainerCard"}),"(\u5e76\u4e0d\u5c40\u9650\u4e8e\u8fd9\u56db\u4e2a\u51fd\u6570\uff0c\u968f\u9700\u6c42\u6dfb\u52a0)\uff0c\u6b64\u65f6\u573a\u666f\u91cc\u6240\u6709\u7684Task\u5f00\u59cb\u8fd0\u4f5c\uff0cSprite\u52a8\u753b\u5f00\u59cb\u751f\u6548\uff0c\u7136\u540e\u6de1\u51fa\u6de1\u5165\u6548\u679c\u6267\u884c\uff0c\u6e38\u620f\u6b63\u5e38\u6de1\u5165\u5230\u8bad\u7ec3\u5e08\u5361\u7247\u9875\u9762"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"static void CB2_TrainerCard(void)\n{\n    RunTasks();\n    AnimateSprites();\n    BuildOamBuffer();\n    UpdatePaletteFade();\n}\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"SetVBlankCallback",children:"SetVBlankCallback"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"void SetVBlankCallback(IntrCallback callback);\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\ud83d\udcac\u5c06\u4e3b\u56de\u8c03",(0,i.jsx)(e.code,{children:"gMain.vblankCallback"}),"\u8bbe\u7f6e\u4e3a\u6307\u5b9a\u7684\u51fd\u6570\uff0c\u540c\u6837\u4e5f\u662f\u6e38\u620f\u4e2d\u6700\u5e38\u7528\u7684vblank\u56de\u8c03\u8bbe\u7f6e\u51fd\u6570"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u53c2\u6570"}),(0,i.jsx)(e.th,{children:"\u7c7b\u578b"}),(0,i.jsx)(e.th,{children:"\u4ecb\u7ecd"})]})}),(0,i.jsx)(e.tbody,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"callback"}),(0,i.jsx)(e.td,{children:"IntrCallback"}),(0,i.jsx)(e.td,{children:"\u56de\u8c03\u51fd\u6570\u7684\u5730\u5740"})]})})]}),"\n",(0,i.jsx)(e.p,{children:"\u2714\ufe0f\u5b9e\u4f8b\uff1a"}),"\n",(0,i.jsxs)(e.p,{children:["\u4e0d\u540c\u4e8e",(0,i.jsx)(e.code,{children:"MainCallback2"}),"\uff0cvblankCallback\u66f4\u591a\u7684\u662f\u548c\u56fe\u50cf\u76f8\u5173\u7684\u529f\u80fd\u3002\u540c\u6837\u662f\u8bad\u7ec3\u5e08\u5361\u7247\u7684\u4f8b\u5b50\uff0c",(0,i.jsx)(e.code,{children:"gMain.vblankCallback"}),"\u5728\u521d\u59cb\u5316\u7684\u7b2c\u4e00\u6b65\u57fa\u672c\u5c31\u88ab\u8d4b\u4e3a",(0,i.jsx)(e.code,{children:"NULL"}),"\uff0c\u907f\u514d\u7ee7\u7eed\u52a0\u8f7d\u56fe\u50cf\u6570\u636e\u5230VRAM\uff0c\u6700\u540e\u548c",(0,i.jsx)(e.code,{children:"MainCallback2"}),"\u4e00\u8d77\u91cd\u65b0\u8bbe\u7f6e\u6210\u5f53\u524d\u573a\u666f\u6240\u9700\u7684Vblank\u56de\u8c03\u51fd\u6570"]}),"\n",(0,i.jsxs)(e.p,{children:["VblankCallback\u7684\u51fd\u6570\u4e2d\u9664\u4e863\u4e2a\u57fa\u7840\u7684",(0,i.jsx)(e.code,{children:"LoadOam()"}),"\u3001",(0,i.jsx)(e.code,{children:"ProcessSpriteCopyRequests()"}),"\u3001",(0,i.jsx)(e.code,{children:"TransferPlttBuffer()"}),"\u5916\uff0c\u901a\u5e38\u8fd8\u4f1a\u6dfb\u52a0\u4e00\u4e9b\u522b\u7684\u6548\u679c\uff0c\u6bd4\u5982",(0,i.jsx)(e.code,{children:"ScanlineEffect"}),"\uff0c",(0,i.jsx)(e.code,{children:"bg\u5faa\u73af\u4f4d\u79fb"})]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-c",children:"static void VblankCb_TrainerCard(void)\n{\n    LoadOam();\n    ProcessSpriteCopyRequests();\n    TransferPlttBuffer();\n    BlinkTimeColon();\n    if (sData->allowDMACopy)\n        DmaCopy16(3, &gScanlineEffectRegBuffers[0], &gScanlineEffectRegBuffers[1], 0x140);\n}\n"})})]})}function o(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(h,{...n})}):h(n)}},8453:(n,e,a)=>{a.d(e,{R:()=>r,x:()=>c});var i=a(6540);const l={},s=i.createContext(l);function r(n){const e=i.useContext(s);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),i.createElement(s.Provider,{value:e},n.children)}}}]);